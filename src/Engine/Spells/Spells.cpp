#include "Engine/Spells/Spells.h"

#include <map>
#include <string>

#include "Engine/Party.h"
#include "Engine/Graphics/Indoor.h"
#include "Engine/Graphics/Overlays.h"
#include "Engine/Objects/Actor.h"
#include "Engine/Objects/ObjectList.h"
#include "Engine/Objects/SpriteObject.h"
#include "Engine/SpellFxRenderer.h"
#include "Engine/TurnEngine/TurnEngine.h"

#include "Media/Audio/AudioPlayer.h"

#include "Utility/Math/TrigLut.h"
#include "Library/Random/Random.h"

SpellFxRenderer *spell_fx_renderer = EngineIocContainer::ResolveSpellFxRenderer();

struct SpellStats *pSpellStats = nullptr;

/**
 * @offset 0x4E3ACC
 */
const IndexedArray<SPRITE_OBJECT_TYPE, SPELL_FIRST_WITH_SPRITE, SPELL_LAST_WITH_SPRITE> SpellSpriteMapping = {
    {SPELL_FIRE_TORCH_LIGHT, SPRITE_SPELL_FIRE_TORCH_LIGHT},
    {SPELL_FIRE_FIRE_BOLT, SPRITE_SPELL_FIRE_FIRE_BOLT},
    {SPELL_FIRE_PROTECTION_FROM_FIRE, SPRITE_SPELL_FIRE_PROTECTION_FROM_FIRE},
    {SPELL_FIRE_FIRE_AURA, SPRITE_SPELL_FIRE_FIRE_AURA},
    {SPELL_FIRE_HASTE, SPRITE_SPELL_FIRE_HASTE},
    {SPELL_FIRE_FIREBALL, SPRITE_SPELL_FIRE_FIREBALL},
    {SPELL_FIRE_FIRE_SPIKE, SPRITE_SPELL_FIRE_FIRE_SPIKE},
    {SPELL_FIRE_IMMOLATION, SPRITE_SPELL_FIRE_IMMOLATION},
    {SPELL_FIRE_METEOR_SHOWER, SPRITE_SPELL_FIRE_METEOR_SHOWER},
    {SPELL_FIRE_INFERNO, SPRITE_SPELL_FIRE_INFERNO},
    {SPELL_FIRE_INCINERATE, SPRITE_SPELL_FIRE_INCINERATE},

    {SPELL_AIR_WIZARD_EYE, SPRITE_SPELL_AIR_WIZARD_EYE},
    {SPELL_AIR_FEATHER_FALL, SPRITE_SPELL_AIR_FEATHER_FALL},
    {SPELL_AIR_PROTECTION_FROM_AIR, SPRITE_SPELL_AIR_PROTECTION_FROM_AIR},
    {SPELL_AIR_SPARKS, SPRITE_SPELL_AIR_SPARKS},
    {SPELL_AIR_JUMP, SPRITE_SPELL_AIR_JUMP},
    {SPELL_AIR_SHIELD, SPRITE_SPELL_AIR_SHIELD},
    {SPELL_AIR_LIGHTNING_BOLT, SPRITE_SPELL_AIR_LIGHTNING_BOLT},
    {SPELL_AIR_INVISIBILITY, SPRITE_SPELL_AIR_INVISIBILITY},
    {SPELL_AIR_IMPLOSION, SPRITE_SPELL_AIR_IMPLOSION},
    {SPELL_AIR_FLY, SPRITE_SPELL_AIR_FLY},
    {SPELL_AIR_STARBURST, SPRITE_SPELL_AIR_STARBURST},

    {SPELL_WATER_AWAKEN, SPRITE_SPELL_WATER_AWAKEN},
    {SPELL_WATER_POISON_SPRAY, SPRITE_SPELL_WATER_POISON_SPRAY},
    {SPELL_WATER_PROTECTION_FROM_WATER, SPRITE_SPELL_WATER_PROTECTION_FROM_WATER},
    {SPELL_WATER_ICE_BOLT, SPRITE_SPELL_WATER_ICE_BOLT},
    {SPELL_WATER_WATER_WALK, SPRITE_SPELL_WATER_WATER_WALK},
    {SPELL_WATER_RECHARGE_ITEM, SPRITE_SPELL_WATER_RECHARGE_ITEM},
    {SPELL_WATER_ACID_BURST, SPRITE_SPELL_WATER_ACID_BURST},
    {SPELL_WATER_ENCHANT_ITEM, SPRITE_SPELL_WATER_ENCHANT_ITEM},
    {SPELL_WATER_TOWN_PORTAL, SPRITE_SPELL_WATER_TOWN_PORTAL},
    {SPELL_WATER_ICE_BLAST, SPRITE_SPELL_WATER_ICE_BLAST},
    {SPELL_WATER_LLOYDS_BEACON, SPRITE_SPELL_WATER_LLOYDS_BEACON},

    {SPELL_EARTH_STUN, SPRITE_SPELL_EARTH_STUN},
    {SPELL_EARTH_SLOW, SPRITE_SPELL_EARTH_SLOW},
    {SPELL_EARTH_PROTECTION_FROM_EARTH, SPRITE_SPELL_EARTH_PROTECTION_FROM_EARTH},
    {SPELL_EARTH_DEADLY_SWARM, SPRITE_SPELL_EARTH_DEADLY_SWARM},
    {SPELL_EARTH_STONESKIN, SPRITE_SPELL_EARTH_STONESKIN},
    {SPELL_EARTH_BLADES, SPRITE_SPELL_EARTH_BLADES},
    {SPELL_EARTH_STONE_TO_FLESH, SPRITE_SPELL_EARTH_STONE_TO_FLESH},
    {SPELL_EARTH_ROCK_BLAST, SPRITE_SPELL_EARTH_ROCK_BLAST},
    {SPELL_EARTH_TELEKINESIS, SPRITE_SPELL_EARTH_TELEKINESIS},
    {SPELL_EARTH_DEATH_BLOSSOM, SPRITE_SPELL_EARTH_DEATH_BLOSSOM},
    {SPELL_EARTH_MASS_DISTORTION, SPRITE_SPELL_EARTH_MASS_DISTORTION},

    {SPELL_SPIRIT_DETECT_LIFE, SPRITE_SPELL_SPIRIT_DETECT_LIFE},
    {SPELL_SPIRIT_BLESS, SPRITE_SPELL_SPIRIT_BLESS},
    {SPELL_SPIRIT_FATE, SPRITE_SPELL_SPIRIT_FATE},
    {SPELL_SPIRIT_TURN_UNDEAD, SPRITE_SPELL_SPIRIT_TURN_UNDEAD},
    {SPELL_SPIRIT_REMOVE_CURSE, SPRITE_SPELL_SPIRIT_REMOVE_CURSE},
    {SPELL_SPIRIT_PRESERVATION, SPRITE_SPELL_SPIRIT_PRESERVATION},
    {SPELL_SPIRIT_HEROISM, SPRITE_SPELL_SPIRIT_HEROISM},
    {SPELL_SPIRIT_SPIRIT_LASH, SPRITE_SPELL_SPIRIT_SPIRIT_LASH},
    {SPELL_SPIRIT_RAISE_DEAD, SPRITE_SPELL_SPIRIT_RAISE_DEAD},
    {SPELL_SPIRIT_SHARED_LIFE, SPRITE_SPELL_SPIRIT_SHARED_LIFE},
    {SPELL_SPIRIT_RESSURECTION, SPRITE_SPELL_SPIRIT_RESSURECTION},

    {SPELL_MIND_REMOVE_FEAR, SPRITE_SPELL_MIND_REMOVE_FEAR},
    {SPELL_MIND_MIND_BLAST, SPRITE_SPELL_MIND_MIND_BLAST},
    {SPELL_MIND_PROTECTION_FROM_MIND, SPRITE_SPELL_MIND_PROTECTION_FROM_MIND},
    {SPELL_MIND_TELEPATHY, SPRITE_SPELL_MIND_TELEPATHY},
    {SPELL_MIND_CHARM, SPRITE_SPELL_MIND_CHARM},
    {SPELL_MIND_CURE_PARALYSIS, SPRITE_SPELL_MIND_CURE_PARALYSIS},
    {SPELL_MIND_BERSERK, SPRITE_SPELL_MIND_BERSERK},
    {SPELL_MIND_MASS_FEAR, SPRITE_SPELL_MIND_MASS_FEAR},
    {SPELL_MIND_CURE_INSANITY, SPRITE_SPELL_MIND_CURE_INSANITY},
    {SPELL_MIND_PSYCHIC_SHOCK, SPRITE_SPELL_MIND_PSYCHIC_SHOCK},
    {SPELL_MIND_ENSLAVE, SPRITE_SPELL_MIND_ENSLAVE},

    {SPELL_BODY_CURE_WEAKNESS, SPRITE_SPELL_BODY_CURE_WEAKNESS},
    {SPELL_BODY_FIRST_AID, SPRITE_SPELL_BODY_FIRST_AID},
    {SPELL_BODY_PROTECTION_FROM_BODY, SPRITE_SPELL_BODY_PROTECTION_FROM_BODY},
    {SPELL_BODY_HARM, SPRITE_SPELL_BODY_HARM},
    {SPELL_BODY_REGENERATION, SPRITE_SPELL_BODY_REGENERATION},
    {SPELL_BODY_CURE_POISON, SPRITE_SPELL_BODY_CURE_POISON},
    {SPELL_BODY_HAMMERHANDS, SPRITE_SPELL_BODY_HAMMERHANDS},
    {SPELL_BODY_CURE_DISEASE, SPRITE_SPELL_BODY_CURE_DISEASE},
    {SPELL_BODY_PROTECTION_FROM_MAGIC, SPRITE_SPELL_BODY_PROTECTION_FROM_MAGIC},
    {SPELL_BODY_FLYING_FIST, SPRITE_SPELL_BODY_FLYING_FIST},
    {SPELL_BODY_POWER_CURE, SPRITE_SPELL_BODY_POWER_CURE},

    {SPELL_LIGHT_LIGHT_BOLT, SPRITE_SPELL_LIGHT_LIGHT_BOLT},
    {SPELL_LIGHT_DESTROY_UNDEAD, SPRITE_SPELL_LIGHT_DESTROY_UNDEAD},
    {SPELL_LIGHT_DISPEL_MAGIC, SPRITE_SPELL_LIGHT_DISPEL_MAGIC},
    {SPELL_LIGHT_PARALYZE, SPRITE_SPELL_LIGHT_PARALYZE},
    {SPELL_LIGHT_SUMMON_ELEMENTAL, SPRITE_SPELL_LIGHT_SUMMON_ELEMENTAL},
    {SPELL_LIGHT_DAY_OF_THE_GODS, SPRITE_SPELL_LIGHT_DAY_OF_THE_GODS},
    {SPELL_LIGHT_PRISMATIC_LIGHT, SPRITE_SPELL_LIGHT_PRISMATIC_LIGHT},
    {SPELL_LIGHT_DAY_OF_PROTECTION, SPRITE_SPELL_LIGHT_DAY_OF_PROTECTION},
    {SPELL_LIGHT_HOUR_OF_POWER, SPRITE_SPELL_LIGHT_HOUR_OF_POWER},
    {SPELL_LIGHT_SUNRAY, SPRITE_SPELL_LIGHT_SUNRAY},
    {SPELL_LIGHT_DIVINE_INTERVENTION, SPRITE_SPELL_LIGHT_DIVINE_INTERVENTION},

    {SPELL_DARK_REANIMATE, SPRITE_SPELL_DARK_REANIMATE},
    {SPELL_DARK_TOXIC_CLOUD, SPRITE_SPELL_DARK_TOXIC_CLOUD},
    {SPELL_DARK_VAMPIRIC_WEAPON, SPRITE_SPELL_DARK_VAMPIRIC_WEAPON},
    {SPELL_DARK_SHRINKING_RAY, SPRITE_SPELL_DARK_SHRINKING_RAY},
    {SPELL_DARK_SHARPMETAL, SPRITE_SPELL_DARK_SHARPMETAL},
    {SPELL_DARK_CONTROL_UNDEAD, SPRITE_SPELL_DARK_CONTROL_UNDEAD},
    {SPELL_DARK_PAIN_REFLECTION, SPRITE_SPELL_DARK_PAIN_REFLECTION},
    {SPELL_DARK_SACRIFICE, SPRITE_SPELL_DARK_SACRIFICE},
    {SPELL_DARK_DRAGON_BREATH, SPRITE_SPELL_DARK_DRAGON_BREATH},
    {SPELL_DARK_ARMAGEDDON, SPRITE_SPELL_DARK_ARMAGEDDON},
    {SPELL_DARK_SOULDRINKER, SPRITE_SPELL_DARK_SOULDRINKER},

    {SPELL_BOW_ARROW, SPRITE_ARROW_PROJECTILE},
    {SPELL_101, SPRITE_ARROW_PROJECTILE},
    {SPELL_LASER_PROJECTILE, SPRITE_BLASTER_PROJECTILE}};

SpellData::SpellData(int16_t inNormalMana,
                     int16_t inExpertLevelMana,
                     int16_t inMasterLevelMana,
                     int16_t inMagisterLevelMana,
                     int16_t inNormalLevelRecovery,
                     int16_t inExpertLevelRecovery,
                     int16_t inMasterLevelRecovery,
                     int16_t inMagisterLevelRecovery,
                     int8_t inBaseDamage,
                     int8_t inBonusSkillDamage,
                     int16_t inStats,
                     CharacterSkillMastery inSkillMastery)
    : uNormalLevelMana(inNormalMana),
      uExpertLevelMana(inExpertLevelMana),
      uMasterLevelMana(inMasterLevelMana),
      uMagisterLevelMana(inMagisterLevelMana),
      uNormalLevelRecovery(inNormalLevelRecovery),
      uExpertLevelRecovery(inExpertLevelRecovery),
      uMasterLevelRecovery(inMasterLevelRecovery),
      uMagisterLevelRecovery(inMagisterLevelRecovery),
      baseDamage(inBaseDamage),
      bonusSkillDamage(inBonusSkillDamage),
      stats(inStats),
      skillMastery(inSkillMastery) {}

/**
 * Description of spells.
 *
 *                                                 Mana Novice
 *                                                 |   Mana Expert
 *                                                 |   |   Mana Master
 *                                                 |   |   |   Mana Grandmaster
 *                                                 |   |   |   |     Recovery Novice
 *                                                 |   |   |   |     |     Recovery Expert
 *                                                 |   |   |   |     |     |     Recovery Master
 *                                                 |   |   |   |     |     |     |     Recovery Grandmaster
 *                                                 |   |   |   |     |     |     |     |   Base Damage
 *                                                 |   |   |   |     |     |     |     |   |   Bonus Skill Damage
 *                                                 |   |   |   |     |     |     |     |   |   |  Stats
 *                                                 |   |   |   |     |     |     |     |   |   |  |  Required skill mastery
 *                                                 |   |   |   |     |     |     |     |   |   |  |  |
 */
IndexedArray<SpellData, SPELL_FIRST_REGULAR, SPELL_LAST_REGULAR> pSpellDatas = {
    {SPELL_FIRE_TORCH_LIGHT,            SpellData( 1,  1,  1,  1,   60,   60,   60,   40,  0,  0, 0, CHARACTER_SKILL_MASTERY_NOVICE)},
    {SPELL_FIRE_FIRE_BOLT,              SpellData( 2,  2,  2,  2,  110,  110,  100,   90,  0,  3, 0, CHARACTER_SKILL_MASTERY_NOVICE)},
    {SPELL_FIRE_PROTECTION_FROM_FIRE,   SpellData( 3,  3,  3,  3,  120,  120,  120,  120,  0,  0, 0, CHARACTER_SKILL_MASTERY_NOVICE)},
    {SPELL_FIRE_FIRE_AURA,              SpellData( 4,  4,  4,  4,  120,  120,  120,  120,  0,  0, 0, CHARACTER_SKILL_MASTERY_NOVICE)},
    {SPELL_FIRE_HASTE,                  SpellData( 5,  5,  5,  5,  120,  120,  120,  120,  0,  0, 0, CHARACTER_SKILL_MASTERY_EXPERT)},
    {SPELL_FIRE_FIREBALL,               SpellData( 8 , 8,  8,  8,  100,  100,   90,   80,  0,  6, 0, CHARACTER_SKILL_MASTERY_EXPERT)},
    {SPELL_FIRE_FIRE_SPIKE,             SpellData(10, 10, 10, 10,  150,  150,  150,  150,  0,  6, 0, CHARACTER_SKILL_MASTERY_EXPERT)},
    {SPELL_FIRE_IMMOLATION,             SpellData(15, 15, 15, 15,  120,  120,  120,  120,  0,  6, 0, CHARACTER_SKILL_MASTERY_MASTER)},
    {SPELL_FIRE_METEOR_SHOWER,          SpellData(20, 20, 20, 20,  100,  100,  100,   90,  8,  1, 0, CHARACTER_SKILL_MASTERY_MASTER)},
    {SPELL_FIRE_INFERNO,                SpellData(25, 25, 25, 25,  100,  100,  100,   90, 12,  1, 0, CHARACTER_SKILL_MASTERY_MASTER)},
    {SPELL_FIRE_INCINERATE,             SpellData(30, 30, 30, 30,   90,   90,   90,   90, 15, 15, 0, CHARACTER_SKILL_MASTERY_GRANDMASTER)},

    {SPELL_AIR_WIZARD_EYE,              SpellData( 1,  1,  1,  0,   60,   60,   60,   60,  0,  0, 0, CHARACTER_SKILL_MASTERY_NOVICE)},
    {SPELL_AIR_FEATHER_FALL,            SpellData( 2,  2,  2,  2,  120,  120,  120,  100,  0,  0, 0, CHARACTER_SKILL_MASTERY_NOVICE)},
    {SPELL_AIR_PROTECTION_FROM_AIR,     SpellData( 3,  3,  3,  3,  120,  120,  120,  120,  0,  0, 0, CHARACTER_SKILL_MASTERY_NOVICE)},
    {SPELL_AIR_SPARKS,                  SpellData( 4,  4,  4,  4,  110,  100,   90,   80,  2,  1, 0, CHARACTER_SKILL_MASTERY_NOVICE)},
    {SPELL_AIR_JUMP,                    SpellData( 5,  5,  5,  5,   90,   90,   70,   50,  0,  0, 0, CHARACTER_SKILL_MASTERY_EXPERT)},
    {SPELL_AIR_SHIELD,                  SpellData( 8,  8,  8,  8,  120,  120,  120,  120,  0,  0, 0, CHARACTER_SKILL_MASTERY_EXPERT)},
    {SPELL_AIR_LIGHTNING_BOLT,          SpellData(10, 10, 10, 10,  100,  100,   90,   70,  0,  8, 0, CHARACTER_SKILL_MASTERY_EXPERT)},
    {SPELL_AIR_INVISIBILITY,            SpellData(15, 15, 15, 15,  200,  200,  200,  200,  0,  0, 0, CHARACTER_SKILL_MASTERY_MASTER)},
    {SPELL_AIR_IMPLOSION,               SpellData(20, 20, 20, 20,  100,  100,  100,   90, 10, 10, 0, CHARACTER_SKILL_MASTERY_MASTER)},
    {SPELL_AIR_FLY,                     SpellData(25, 25, 25, 25,  250,  250,  250,  250,  0,  0, 0, CHARACTER_SKILL_MASTERY_MASTER)},
    {SPELL_AIR_STARBURST,               SpellData(30, 30, 30, 30,   90,   90,   90,   90, 20,  1, 0, CHARACTER_SKILL_MASTERY_GRANDMASTER)},

    {SPELL_WATER_AWAKEN,                SpellData( 1,  1,  1,  1,   60,   60,   60,   20,  0,  0, 0, CHARACTER_SKILL_MASTERY_NOVICE)},
    {SPELL_WATER_POISON_SPRAY,          SpellData( 2,  2,  2,  2,  110,  100,   90,   70,  2,  2, 0, CHARACTER_SKILL_MASTERY_NOVICE)},
    {SPELL_WATER_PROTECTION_FROM_WATER, SpellData( 3,  3,  3,  3,  120,  120,  120,  120,  0,  0, 0, CHARACTER_SKILL_MASTERY_NOVICE)},
    {SPELL_WATER_ICE_BOLT,              SpellData( 4,  4,  4,  4,  110,  100,   90,   80,  0,  4, 0, CHARACTER_SKILL_MASTERY_NOVICE)},
    {SPELL_WATER_WATER_WALK,            SpellData( 5,  5,  5,  5,  150,  150,  150,  150,  0,  0, 0, CHARACTER_SKILL_MASTERY_EXPERT)},
    {SPELL_WATER_RECHARGE_ITEM,         SpellData( 8,  8,  8,  8,  200,  200,  200,  200,  0,  0, 0, CHARACTER_SKILL_MASTERY_EXPERT)},
    {SPELL_WATER_ACID_BURST,            SpellData(10, 10, 10, 10,  100,  100,   90,   80,  9,  9, 0, CHARACTER_SKILL_MASTERY_EXPERT)},
    {SPELL_WATER_ENCHANT_ITEM,          SpellData(15, 15, 15, 15,  140,  140,  140,  140,  0,  0, 0, CHARACTER_SKILL_MASTERY_MASTER)},
    {SPELL_WATER_TOWN_PORTAL,           SpellData(20, 20, 20, 20,  200,  200,  200,  200,  0,  0, 0, CHARACTER_SKILL_MASTERY_MASTER)},
    {SPELL_WATER_ICE_BLAST,             SpellData(25, 25, 25, 25,   80,   80,   80,   80, 12,  3, 0, CHARACTER_SKILL_MASTERY_MASTER)},
    {SPELL_WATER_LLOYDS_BEACON,         SpellData(30, 30, 30, 30,  250,  250,  250,  250,  0,  0, 0, CHARACTER_SKILL_MASTERY_GRANDMASTER)},

    {SPELL_EARTH_STUN,                  SpellData( 1,  1,  1,  1,   80,   80,   80,   80,  0,  0, 0, CHARACTER_SKILL_MASTERY_NOVICE)},
    {SPELL_EARTH_SLOW,                  SpellData( 2,  2,  2,  2,  100,  100,  100,  100,  0,  0, 0, CHARACTER_SKILL_MASTERY_NOVICE)},
    {SPELL_EARTH_PROTECTION_FROM_EARTH, SpellData( 3,  3,  3,  3,  120,  120,  120,  120,  0,  0, 0, CHARACTER_SKILL_MASTERY_NOVICE)},
    {SPELL_EARTH_DEADLY_SWARM,          SpellData( 4,  4,  4,  4,  110,  100,   90,   80,  5,  3, 0, CHARACTER_SKILL_MASTERY_NOVICE)},
    {SPELL_EARTH_STONESKIN,             SpellData( 5,  5,  5,  5,  120,  120,  120,  120,  0,  0, 0, CHARACTER_SKILL_MASTERY_EXPERT)},
    {SPELL_EARTH_BLADES,                SpellData( 8,  8,  8,  8,  100,  100,   90,   80,  0,  9, 0, CHARACTER_SKILL_MASTERY_EXPERT)},
    {SPELL_EARTH_STONE_TO_FLESH,        SpellData(10, 10, 10, 10,  140,  140,  140,  140,  0,  0, 0, CHARACTER_SKILL_MASTERY_EXPERT)},
    {SPELL_EARTH_ROCK_BLAST,            SpellData(15, 15, 15, 15,   90,   90,   90,   80,  0,  8, 0, CHARACTER_SKILL_MASTERY_MASTER)},
    {SPELL_EARTH_TELEKINESIS,           SpellData(20, 20, 20, 20,  150,  150,  150,  150,  0,  0, 0, CHARACTER_SKILL_MASTERY_MASTER)},
    {SPELL_EARTH_DEATH_BLOSSOM,         SpellData(25, 25, 25, 25,  100,  100,  100,   90, 20,  1, 0, CHARACTER_SKILL_MASTERY_MASTER)},
    {SPELL_EARTH_MASS_DISTORTION,       SpellData(30, 30, 30, 30,   90,   90,   90,   90, 25,  0, 0, CHARACTER_SKILL_MASTERY_GRANDMASTER)},

    {SPELL_SPIRIT_DETECT_LIFE,          SpellData( 1,  1,  1,  1,  100,  100,  100,  100,  0,  0, 0, CHARACTER_SKILL_MASTERY_NOVICE)},
    {SPELL_SPIRIT_BLESS,                SpellData( 2,  2,  2,  2,  100,  100,  100,  100,  0,  0, 0, CHARACTER_SKILL_MASTERY_NOVICE)},
    {SPELL_SPIRIT_FATE,                 SpellData( 3,  3,  3,  3,   90,   90,   90,   90,  0,  0, 0, CHARACTER_SKILL_MASTERY_NOVICE)},
    {SPELL_SPIRIT_TURN_UNDEAD,          SpellData( 4,  4,  4,  4,  120,  120,  120,  120,  0,  0, 0, CHARACTER_SKILL_MASTERY_NOVICE)},
    {SPELL_SPIRIT_REMOVE_CURSE,         SpellData( 5,  5,  5,  5,  120,  120,  120,  120,  0,  0, 0, CHARACTER_SKILL_MASTERY_EXPERT)},
    {SPELL_SPIRIT_PRESERVATION,         SpellData( 8,  8,  8,  8,  120,  120,  120,  120,  0,  0, 0, CHARACTER_SKILL_MASTERY_EXPERT)},
    {SPELL_SPIRIT_HEROISM,              SpellData(10, 10, 10, 10,  120,  120,  120,  120,  0,  0, 0, CHARACTER_SKILL_MASTERY_EXPERT)},
    {SPELL_SPIRIT_SPIRIT_LASH,          SpellData(15, 15, 15, 15,  100,  100,  100,  100, 10,  8, 0, CHARACTER_SKILL_MASTERY_MASTER)},
    {SPELL_SPIRIT_RAISE_DEAD,           SpellData(20, 20, 20, 20,  240,  240,  240,  240,  0,  0, 0, CHARACTER_SKILL_MASTERY_MASTER)},
    {SPELL_SPIRIT_SHARED_LIFE,          SpellData(25, 25, 25, 25,  150,  150,  150,  150,  0,  0, 0, CHARACTER_SKILL_MASTERY_MASTER)},
    {SPELL_SPIRIT_RESSURECTION,         SpellData(30, 30, 30, 30, 1000, 1000, 1000, 1000,  0,  0, 0, CHARACTER_SKILL_MASTERY_GRANDMASTER)},

    {SPELL_MIND_REMOVE_FEAR,            SpellData( 1,  1,  1,  1,  120,  120,  120,  120,  0,  0, 0, CHARACTER_SKILL_MASTERY_NOVICE)},
    {SPELL_MIND_MIND_BLAST,             SpellData( 2,  2,  2,  2,  110,  110,  110,  110,  3,  3, 0, CHARACTER_SKILL_MASTERY_NOVICE)},
    {SPELL_MIND_PROTECTION_FROM_MIND,   SpellData( 3,  3,  3,  3,  120,  120,  120,  120,  0,  0, 0, CHARACTER_SKILL_MASTERY_NOVICE)},
    {SPELL_MIND_TELEPATHY,              SpellData( 4,  4,  4,  4,  110,  100,   90,   80,  0,  0, 0, CHARACTER_SKILL_MASTERY_NOVICE)},
    {SPELL_MIND_CHARM,                  SpellData( 5,  5,  5,  5,  100,  100,  100,  100,  0,  0, 0, CHARACTER_SKILL_MASTERY_EXPERT)},
    {SPELL_MIND_CURE_PARALYSIS,         SpellData( 8,  8,  8,  8,  120,  120,  120,  120,  0,  0, 0, CHARACTER_SKILL_MASTERY_EXPERT)},
    {SPELL_MIND_BERSERK,                SpellData(10, 10, 10, 10,  120,  120,  120,  120,  0,  0, 0, CHARACTER_SKILL_MASTERY_EXPERT)},
    {SPELL_MIND_MASS_FEAR,              SpellData(15, 15, 15, 15,   80,   80,   80,   80,  0,  0, 0, CHARACTER_SKILL_MASTERY_MASTER)},
    {SPELL_MIND_CURE_INSANITY,          SpellData(20, 20, 20, 20,  120,  120,  120,  120,  0,  0, 0, CHARACTER_SKILL_MASTERY_MASTER)},
    {SPELL_MIND_PSYCHIC_SHOCK,          SpellData(25, 25, 25, 25,  110,  110,  110,  100, 12,  1, 0, CHARACTER_SKILL_MASTERY_MASTER)},
    {SPELL_MIND_ENSLAVE,                SpellData(30, 30, 30, 30,  120,  120,  120,  120,  0,  0, 0, CHARACTER_SKILL_MASTERY_GRANDMASTER)},

    {SPELL_BODY_CURE_WEAKNESS,          SpellData( 1,  1,  1,  1,  120,  120,  120,  120,  0,  0, 0, CHARACTER_SKILL_MASTERY_NOVICE)},
    {SPELL_BODY_FIRST_AID,              SpellData( 2,  2,  2,  2,  100,  100,  100,  100,  0,  0, 0, CHARACTER_SKILL_MASTERY_NOVICE)},
    {SPELL_BODY_PROTECTION_FROM_BODY,   SpellData( 3,  3,  3,  3,  120,  120,  120,  120,  0,  0, 0, CHARACTER_SKILL_MASTERY_NOVICE)},
    {SPELL_BODY_HARM,                   SpellData( 4,  4,  4,  4,  110,  100,   90,   80,  8,  2, 0, CHARACTER_SKILL_MASTERY_NOVICE)},
    {SPELL_BODY_REGENERATION,           SpellData( 5,  5,  5,  5,  110,  110,  110,  110,  0,  0, 0, CHARACTER_SKILL_MASTERY_EXPERT)},
    {SPELL_BODY_CURE_POISON,            SpellData( 8,  8,  8,  8,  120,  120,  120,  120,  0,  0, 0, CHARACTER_SKILL_MASTERY_EXPERT)},
    {SPELL_BODY_HAMMERHANDS,            SpellData(10, 10, 10, 10,  120,  120,  120,  120,  0,  0, 0, CHARACTER_SKILL_MASTERY_EXPERT)},
    {SPELL_BODY_CURE_DISEASE,           SpellData(15, 15, 15, 15,  120,  120,  120,  120,  0,  0, 0, CHARACTER_SKILL_MASTERY_MASTER)},
    {SPELL_BODY_PROTECTION_FROM_MAGIC,  SpellData(20, 20, 20, 20,  120,  120,  120,  120,  0,  0, 0, CHARACTER_SKILL_MASTERY_MASTER)},
    {SPELL_BODY_FLYING_FIST,            SpellData(25, 25, 25, 25,  110,  110,  110,  100, 30,  5, 0, CHARACTER_SKILL_MASTERY_MASTER)},
    {SPELL_BODY_POWER_CURE,             SpellData(30, 30, 30, 30,  100,  100,  100,  100,  0,  0, 0, CHARACTER_SKILL_MASTERY_GRANDMASTER)},

    {SPELL_LIGHT_LIGHT_BOLT,            SpellData( 5,  5,  5,  5,  110,  100,   90,   80,  0,  4, 0, CHARACTER_SKILL_MASTERY_NOVICE)},
    {SPELL_LIGHT_DESTROY_UNDEAD,        SpellData(10, 10, 10, 10,  120,  110,  100,   90, 16, 16, 0, CHARACTER_SKILL_MASTERY_NOVICE)},
    {SPELL_LIGHT_DISPEL_MAGIC,          SpellData(15, 15, 15, 15,  120,  110,  100,   90,  0,  0, 0, CHARACTER_SKILL_MASTERY_NOVICE)},
    {SPELL_LIGHT_PARALYZE,              SpellData(20, 20, 20, 20,  160,  140,  120,  100,  0,  0, 0, CHARACTER_SKILL_MASTERY_NOVICE)},
    {SPELL_LIGHT_SUMMON_ELEMENTAL,      SpellData(25, 25, 25, 25,  140,  140,  140,  140,  0,  0, 0, CHARACTER_SKILL_MASTERY_EXPERT)},
    {SPELL_LIGHT_DAY_OF_THE_GODS,       SpellData(30, 30, 30, 30,  500,  500,  500,  500,  0,  0, 0, CHARACTER_SKILL_MASTERY_EXPERT)},
    {SPELL_LIGHT_PRISMATIC_LIGHT,       SpellData(35, 35, 35, 35,  135,  135,  120,  100, 25,  1, 0, CHARACTER_SKILL_MASTERY_EXPERT)},
    {SPELL_LIGHT_DAY_OF_PROTECTION,     SpellData(40, 40, 40, 40,  500,  500,  500,  500,  0,  0, 0, CHARACTER_SKILL_MASTERY_MASTER)},
    {SPELL_LIGHT_HOUR_OF_POWER,         SpellData(45, 45, 45, 45,  250,  250,  250,  250,  0,  0, 0, CHARACTER_SKILL_MASTERY_MASTER)},
    {SPELL_LIGHT_SUNRAY,                SpellData(50, 50, 50, 50,  150,  150,  150,  135, 20, 20, 0, CHARACTER_SKILL_MASTERY_MASTER)},
    {SPELL_LIGHT_DIVINE_INTERVENTION,   SpellData(55, 55, 55, 55,  300,  300,  300,  300,  0,  0, 0, CHARACTER_SKILL_MASTERY_GRANDMASTER)},

    {SPELL_DARK_REANIMATE,              SpellData(10, 10, 10, 10,  140,  140,  140,  140,  0,  0, 0, CHARACTER_SKILL_MASTERY_NOVICE)},
    {SPELL_DARK_TOXIC_CLOUD,            SpellData(15, 15, 15, 15,  120,  110,  100,   90, 25, 10, 0, CHARACTER_SKILL_MASTERY_NOVICE)},
    {SPELL_DARK_VAMPIRIC_WEAPON,        SpellData(20, 20, 20, 20,  120,  100,   90,  120,  0,  0, 0, CHARACTER_SKILL_MASTERY_NOVICE)},
    {SPELL_DARK_SHRINKING_RAY,          SpellData(25, 25, 25, 25,  120,  120,  120,  120,  0,  0, 0, CHARACTER_SKILL_MASTERY_NOVICE)},
    {SPELL_DARK_SHARPMETAL,             SpellData(30, 30, 30, 30,   90,   90,   80,   70,  6,  6, 0, CHARACTER_SKILL_MASTERY_EXPERT)},
    {SPELL_DARK_CONTROL_UNDEAD,         SpellData(35, 35, 35, 35,  120,  120,  100,   80,  0,  0, 0, CHARACTER_SKILL_MASTERY_EXPERT)},
    {SPELL_DARK_PAIN_REFLECTION,        SpellData(40, 40, 40, 40,  110,  110,  110,  110,  0,  0, 0, CHARACTER_SKILL_MASTERY_EXPERT)},
    {SPELL_DARK_SACRIFICE,              SpellData(45, 45, 45, 45,  200,  200,  200,  150,  0,  0, 0, CHARACTER_SKILL_MASTERY_MASTER)},
    {SPELL_DARK_DRAGON_BREATH,          SpellData(50, 50, 50, 50,  120,  120,  120,  100,  0, 25, 0, CHARACTER_SKILL_MASTERY_MASTER)},
    {SPELL_DARK_ARMAGEDDON,             SpellData(55, 55, 55, 55,  250,  250,  250,  250, 50,  1, 0, CHARACTER_SKILL_MASTERY_MASTER)},
    {SPELL_DARK_SOULDRINKER,            SpellData(60, 60, 60, 60,  300,  300,  300,  300, 25,  8, 0, CHARACTER_SKILL_MASTERY_GRANDMASTER)}
};

const IndexedArray<SPELL_TYPE, ITEM_FIRST_WAND, ITEM_LAST_WAND> wandSpellIds = {
    {ITEM_WAND_OF_FIRE,                SPELL_FIRE_FIRE_BOLT},
    {ITEM_WAND_OF_SPARKS,              SPELL_AIR_SPARKS},
    {ITEM_WAND_OF_POISON,              SPELL_WATER_POISON_SPRAY},
    {ITEM_WAND_OF_STUNNING,            SPELL_EARTH_STUN},
    {ITEM_WAND_OF_HARM,                SPELL_BODY_HARM},

    {ITEM_FAIRY_WAND_OF_LIGHT,         SPELL_LIGHT_LIGHT_BOLT},
    {ITEM_FAIRY_WAND_OF_ICE,           SPELL_WATER_ICE_BOLT},
    {ITEM_FAIRY_WAND_OF_LASHING,       SPELL_SPIRIT_SPIRIT_LASH},
    {ITEM_FAIRY_WAND_OF_MIND,          SPELL_MIND_MIND_BLAST},
    {ITEM_FAIRY_WAND_OF_SWARMS,        SPELL_EARTH_DEADLY_SWARM},

    {ITEM_ALACORN_WAND_OF_FIREBALLS,   SPELL_FIRE_FIREBALL},
    {ITEM_ALACORN_WAND_OF_ACID,        SPELL_WATER_ACID_BURST},
    {ITEM_ALACORN_WAND_OF_LIGHTNING,   SPELL_AIR_LIGHTNING_BOLT},
    {ITEM_ALACORN_WAND_OF_BLADES,      SPELL_EARTH_BLADES},
    {ITEM_ALACORN_WAND_OF_CHARMS,      SPELL_MIND_CHARM},

    {ITEM_ARCANE_WAND_OF_BLASTING,     SPELL_WATER_ICE_BLAST},
    {ITEM_ARCANE_WAND_OF_THE_FIST,     SPELL_BODY_FLYING_FIST},
    {ITEM_ARCANE_WAND_OF_ROCKS,        SPELL_EARTH_ROCK_BLAST},
    {ITEM_ARCANE_WAND_OF_PARALYZING,   SPELL_LIGHT_PARALYZE},
    {ITEM_ARCANE_WAND_OF_CLOUDS,       SPELL_DARK_TOXIC_CLOUD},

    {ITEM_MYSTIC_WAND_OF_IMPLOSION,    SPELL_AIR_IMPLOSION},
    {ITEM_MYSTIC_WAND_OF_DISTORTION,   SPELL_EARTH_MASS_DISTORTION},
    {ITEM_MYSTIC_WAND_OF_SHRAPMETAL,   SPELL_DARK_SHARPMETAL},
    {ITEM_MYSTIC_WAND_OF_SHRINKING,    SPELL_DARK_SHRINKING_RAY},
    {ITEM_MYSTIC_WAND_OF_INCINERATION, SPELL_FIRE_INCINERATE}
};

const IndexedArray<SPELL_TYPE, ITEM_FIRST_SPELL_SCROLL, ITEM_LAST_SPELL_SCROLL> scrollSpellIds = {
    {ITEM_SCROLL_TORCH_LIGHT,           SPELL_FIRE_TORCH_LIGHT},
    {ITEM_SCROLL_FIRE_BOLT,             SPELL_FIRE_FIRE_BOLT},
    {ITEM_SCROLL_FIRE_RESISTANCE,       SPELL_FIRE_PROTECTION_FROM_FIRE},
    {ITEM_SCROLL_FIRE_AURA,             SPELL_FIRE_FIRE_AURA},
    {ITEM_SCROLL_HASTE,                 SPELL_FIRE_HASTE},
    {ITEM_SCROLL_FIREBALL,              SPELL_FIRE_FIREBALL},
    {ITEM_SCROLL_FIRE_SPIKE,            SPELL_FIRE_FIRE_SPIKE},
    {ITEM_SCROLL_IMMOLATION,            SPELL_FIRE_IMMOLATION},
    {ITEM_SCROLL_METEOR_SHOWER,         SPELL_FIRE_METEOR_SHOWER},
    {ITEM_SCROLL_INFERNO,               SPELL_FIRE_INFERNO},
    {ITEM_SCROLL_INCINERATE,            SPELL_FIRE_INCINERATE},

    {ITEM_SCROLL_WIZARD_EYE,            SPELL_AIR_WIZARD_EYE},
    {ITEM_SCROLL_FEATHER_FALL,          SPELL_AIR_FEATHER_FALL},
    {ITEM_SCROLL_AIR_RESISTANCE,        SPELL_AIR_PROTECTION_FROM_AIR},
    {ITEM_SCROLL_SPARKS,                SPELL_AIR_SPARKS},
    {ITEM_SCROLL_JUMP,                  SPELL_AIR_JUMP},
    {ITEM_SCROLL_SHIELD,                SPELL_AIR_SHIELD},
    {ITEM_SCROLL_LIGHTNING_BOLT,        SPELL_AIR_LIGHTNING_BOLT},
    {ITEM_SCROLL_INVISIBILITY,          SPELL_AIR_INVISIBILITY},
    {ITEM_SCROLL_IMPLOSION,             SPELL_AIR_IMPLOSION},
    {ITEM_SCROLL_FLY,                   SPELL_AIR_FLY},
    {ITEM_SCROLL_STARBURST,             SPELL_AIR_STARBURST},

    {ITEM_SCROLL_AWAKEN,                SPELL_WATER_AWAKEN},
    {ITEM_SCROLL_POISON_SPRAY,          SPELL_WATER_POISON_SPRAY},
    {ITEM_SCROLL_WATER_RESISTANCE,      SPELL_WATER_PROTECTION_FROM_WATER},
    {ITEM_SCROLL_ICE_BOLT,              SPELL_WATER_ICE_BOLT},
    {ITEM_SCROLL_WATER_WALK,            SPELL_WATER_WATER_WALK},
    {ITEM_SCROLL_RECHARGE_ITEM,         SPELL_WATER_RECHARGE_ITEM},
    {ITEM_SCROLL_ACID_BURST,            SPELL_WATER_ACID_BURST},
    {ITEM_SCROLL_ENCHANT_ITEM,          SPELL_WATER_ENCHANT_ITEM},
    {ITEM_SCROLL_TOWN_PORTAL,           SPELL_WATER_TOWN_PORTAL},
    {ITEM_SCROLL_ICE_BLAST,             SPELL_WATER_ICE_BLAST},
    {ITEM_SCROLL_LLOYDS_BEACON,         SPELL_WATER_LLOYDS_BEACON},

    {ITEM_SCROLL_STUN,                  SPELL_EARTH_STUN},
    {ITEM_SCROLL_SLOW,                  SPELL_EARTH_SLOW},
    {ITEM_SCROLL_EARTH_RESISTANCE,      SPELL_EARTH_PROTECTION_FROM_EARTH},
    {ITEM_SCROLL_DEADLY_SWARM,          SPELL_EARTH_DEADLY_SWARM},
    {ITEM_SCROLL_STONE_SKIN,            SPELL_EARTH_STONESKIN},
    {ITEM_SCROLL_BLADES,                SPELL_EARTH_BLADES},
    {ITEM_SCROLL_STONE_TO_FLESH,        SPELL_EARTH_STONE_TO_FLESH},
    {ITEM_SCROLL_ROCK_BLAST,            SPELL_EARTH_ROCK_BLAST},
    {ITEM_SCROLL_TELEKINESIS,           SPELL_EARTH_TELEKINESIS},
    {ITEM_SCROLL_DEATH_BLOSSOM,         SPELL_EARTH_DEATH_BLOSSOM},
    {ITEM_SCROLL_MASS_DISTORTION,       SPELL_EARTH_MASS_DISTORTION},

    {ITEM_SCROLL_DETECT_LIFE,           SPELL_SPIRIT_DETECT_LIFE},
    {ITEM_SCROLL_BLESS,                 SPELL_SPIRIT_BLESS},
    {ITEM_SCROLL_FATE,                  SPELL_SPIRIT_FATE},
    {ITEM_SCROLL_TURN_UNDEAD,           SPELL_SPIRIT_TURN_UNDEAD},
    {ITEM_SCROLL_REMOVE_CURSE,          SPELL_SPIRIT_REMOVE_CURSE},
    {ITEM_SCROLL_PRESERVATION,          SPELL_SPIRIT_PRESERVATION},
    {ITEM_SCROLL_HEROISM,               SPELL_SPIRIT_HEROISM},
    {ITEM_SCROLL_SPIRIT_LASH,           SPELL_SPIRIT_SPIRIT_LASH},
    {ITEM_SCROLL_RAISE_DEAD,            SPELL_SPIRIT_RAISE_DEAD},
    {ITEM_SCROLL_SHARED_LIFE,           SPELL_SPIRIT_SHARED_LIFE},
    {ITEM_SCROLL_RESURRECTION,          SPELL_SPIRIT_RESSURECTION},

    {ITEM_SCROLL_REMOVE_FEAR,           SPELL_MIND_REMOVE_FEAR},
    {ITEM_SCROLL_MIND_BLAST,            SPELL_MIND_MIND_BLAST},
    {ITEM_SCROLL_MIND_RESISTANCE,       SPELL_MIND_PROTECTION_FROM_MIND},
    {ITEM_SCROLL_TELEPATHY,             SPELL_MIND_TELEPATHY},
    {ITEM_SCROLL_CHARM,                 SPELL_MIND_CHARM},
    {ITEM_SCROLL_CURE_PARALYSIS,        SPELL_MIND_CURE_PARALYSIS},
    {ITEM_SCROLL_BERSERK,               SPELL_MIND_BERSERK},
    {ITEM_SCROLL_MASS_FEAR,             SPELL_MIND_MASS_FEAR},
    {ITEM_SCROLL_CURE_INSANITY,         SPELL_MIND_CURE_INSANITY},
    {ITEM_SCROLL_PSYCHIC_SHOCK,         SPELL_MIND_PSYCHIC_SHOCK},
    {ITEM_SCROLL_ENSLAVE,               SPELL_MIND_ENSLAVE},

    {ITEM_SCROLL_CURE_WEAKNESS,         SPELL_BODY_CURE_WEAKNESS},
    {ITEM_SCROLL_HEAL,                  SPELL_BODY_FIRST_AID},
    {ITEM_SCROLL_BODY_RESISTANCE,       SPELL_BODY_PROTECTION_FROM_BODY},
    {ITEM_SCROLL_HARM,                  SPELL_BODY_HARM},
    {ITEM_SCROLL_REGENERATION,          SPELL_BODY_REGENERATION},
    {ITEM_SCROLL_CURE_POISON,           SPELL_BODY_CURE_POISON},
    {ITEM_SCROLL_HAMMERHANDS,           SPELL_BODY_HAMMERHANDS},
    {ITEM_SCROLL_CURE_DISEASE,          SPELL_BODY_CURE_DISEASE},
    {ITEM_SCROLL_PROTECTION_FROM_MAGIC, SPELL_BODY_PROTECTION_FROM_MAGIC},
    {ITEM_SCROLL_FLYING_FIST,           SPELL_BODY_FLYING_FIST},
    {ITEM_SCROLL_POWER_CURE,            SPELL_BODY_POWER_CURE},

    {ITEM_SCROLL_LIGHT_BOLT,            SPELL_LIGHT_LIGHT_BOLT},
    {ITEM_SCROLL_DESTROY_UNDEAD,        SPELL_LIGHT_DESTROY_UNDEAD},
    {ITEM_SCROLL_DISPEL_MAGIC,          SPELL_LIGHT_DISPEL_MAGIC},
    {ITEM_SCROLL_PARALYZE,              SPELL_LIGHT_PARALYZE},
    {ITEM_SCROLL_SUMMON_ELEMENTAL,      SPELL_LIGHT_SUMMON_ELEMENTAL},
    {ITEM_SCROLL_DAY_OF_THE_GODS,       SPELL_LIGHT_DAY_OF_THE_GODS},
    {ITEM_SCROLL_PRISMATIC_LIGHT,       SPELL_LIGHT_PRISMATIC_LIGHT},
    {ITEM_SCROLL_DAY_OF_PROTECTION,     SPELL_LIGHT_DAY_OF_PROTECTION},
    {ITEM_SCROLL_HOUR_OF_POWER,         SPELL_LIGHT_HOUR_OF_POWER},
    {ITEM_SCROLL_SUNRAY,                SPELL_LIGHT_SUNRAY},
    {ITEM_SCROLL_DIVINE_INTERVENTION,   SPELL_LIGHT_DIVINE_INTERVENTION},

    {ITEM_SCROLL_REANIMATE,             SPELL_DARK_REANIMATE},
    {ITEM_SCROLL_TOXIC_CLOUD,           SPELL_DARK_TOXIC_CLOUD},
    {ITEM_SCROLL_VAMPIRIC_WEAPON,       SPELL_DARK_VAMPIRIC_WEAPON},
    {ITEM_SCROLL_SHRINKING_RAY,         SPELL_DARK_SHRINKING_RAY},
    {ITEM_SCROLL_SHRAPMETAL,            SPELL_DARK_SHARPMETAL},
    {ITEM_SCROLL_CONTROL_UNDEAD,        SPELL_DARK_CONTROL_UNDEAD},
    {ITEM_SCROLL_PAIN_REFLECTION,       SPELL_DARK_PAIN_REFLECTION},
    {ITEM_SCROLL_SACRIFICE,             SPELL_DARK_SACRIFICE},
    {ITEM_SCROLL_DRAGON_BREATH,         SPELL_DARK_DRAGON_BREATH},
    {ITEM_SCROLL_ARMAGEDDON,            SPELL_DARK_ARMAGEDDON},
    {ITEM_SCROLL_SOULDRINKER,           SPELL_DARK_SOULDRINKER}
};

const IndexedArray<SPELL_TYPE, ITEM_FIRST_SPELL_BOOK, ITEM_LAST_SPELL_BOOK> bookSpellIds = {
    {ITEM_SPELLBOOK_TORCH_LIGHT,           SPELL_FIRE_TORCH_LIGHT},
    {ITEM_SPELLBOOK_FIRE_BOLT,             SPELL_FIRE_FIRE_BOLT},
    {ITEM_SPELLBOOK_FIRE_RESISTANCE,       SPELL_FIRE_PROTECTION_FROM_FIRE},
    {ITEM_SPELLBOOK_FIRE_AURA,             SPELL_FIRE_FIRE_AURA},
    {ITEM_SPELLBOOK_HASTE,                 SPELL_FIRE_HASTE},
    {ITEM_SPELLBOOK_FIREBALL,              SPELL_FIRE_FIREBALL},
    {ITEM_SPELLBOOK_FIRE_SPIKE,            SPELL_FIRE_FIRE_SPIKE},
    {ITEM_SPELLBOOK_IMMOLATION,            SPELL_FIRE_IMMOLATION},
    {ITEM_SPELLBOOK_METEOR_SHOWER,         SPELL_FIRE_METEOR_SHOWER},
    {ITEM_SPELLBOOK_INFERNO,               SPELL_FIRE_INFERNO},
    {ITEM_SPELLBOOK_INCINERATE,            SPELL_FIRE_INCINERATE},

    {ITEM_SPELLBOOK_WIZARD_EYE,            SPELL_AIR_WIZARD_EYE},
    {ITEM_SPELLBOOK_FEATHER_FALL,          SPELL_AIR_FEATHER_FALL},
    {ITEM_SPELLBOOK_AIR_RESISTANCE,        SPELL_AIR_PROTECTION_FROM_AIR},
    {ITEM_SPELLBOOK_SPARKS,                SPELL_AIR_SPARKS},
    {ITEM_SPELLBOOK_JUMP,                  SPELL_AIR_JUMP},
    {ITEM_SPELLBOOK_SHIELD,                SPELL_AIR_SHIELD},
    {ITEM_SPELLBOOK_LIGHTNING_BOLT,        SPELL_AIR_LIGHTNING_BOLT},
    {ITEM_SPELLBOOK_INVISIBILITY,          SPELL_AIR_INVISIBILITY},
    {ITEM_SPELLBOOK_IMPLOSION,             SPELL_AIR_IMPLOSION},
    {ITEM_SPELLBOOK_FLY,                   SPELL_AIR_FLY},
    {ITEM_SPELLBOOK_STARBURST,             SPELL_AIR_STARBURST},

    {ITEM_SPELLBOOK_AWAKEN,                SPELL_WATER_AWAKEN},
    {ITEM_SPELLBOOK_POISON_SPRAY,          SPELL_WATER_POISON_SPRAY},
    {ITEM_SPELLBOOK_WATER_RESISTANCE,      SPELL_WATER_PROTECTION_FROM_WATER},
    {ITEM_SPELLBOOK_ICE_BOLT,              SPELL_WATER_ICE_BOLT},
    {ITEM_SPELLBOOK_WATER_WALK,            SPELL_WATER_WATER_WALK},
    {ITEM_SPELLBOOK_RECHARGE_ITEM,         SPELL_WATER_RECHARGE_ITEM},
    {ITEM_SPELLBOOK_ACID_BURST,            SPELL_WATER_ACID_BURST},
    {ITEM_SPELLBOOK_ENCHANT_ITEM,          SPELL_WATER_ENCHANT_ITEM},
    {ITEM_SPELLBOOK_TOWN_PORTAL,           SPELL_WATER_TOWN_PORTAL},
    {ITEM_SPELLBOOK_ICE_BLAST,             SPELL_WATER_ICE_BLAST},
    {ITEM_SPELLBOOK_LLOYDS_BEACON,         SPELL_WATER_LLOYDS_BEACON},

    {ITEM_SPELLBOOK_STUN,                  SPELL_EARTH_STUN},
    {ITEM_SPELLBOOK_SLOW,                  SPELL_EARTH_SLOW},
    {ITEM_SPELLBOOK_EARTH_RESISTANCE,      SPELL_EARTH_PROTECTION_FROM_EARTH},
    {ITEM_SPELLBOOK_DEADLY_SWARM,          SPELL_EARTH_DEADLY_SWARM},
    {ITEM_SPELLBOOK_STONE_SKIN,            SPELL_EARTH_STONESKIN},
    {ITEM_SPELLBOOK_BLADES,                SPELL_EARTH_BLADES},
    {ITEM_SPELLBOOK_STONE_TO_FLESH,        SPELL_EARTH_STONE_TO_FLESH},
    {ITEM_SPELLBOOK_ROCK_BLAST,            SPELL_EARTH_ROCK_BLAST},
    {ITEM_SPELLBOOK_TELEKINESIS,           SPELL_EARTH_TELEKINESIS},
    {ITEM_SPELLBOOK_DEATH_BLOSSOM,         SPELL_EARTH_DEATH_BLOSSOM},
    {ITEM_SPELLBOOK_MASS_DISTORTION,       SPELL_EARTH_MASS_DISTORTION},

    {ITEM_SPELLBOOK_DETECT_LIFE,           SPELL_SPIRIT_DETECT_LIFE},
    {ITEM_SPELLBOOK_BLESS,                 SPELL_SPIRIT_BLESS},
    {ITEM_SPELLBOOK_FATE,                  SPELL_SPIRIT_FATE},
    {ITEM_SPELLBOOK_TURN_UNDEAD,           SPELL_SPIRIT_TURN_UNDEAD},
    {ITEM_SPELLBOOK_REMOVE_CURSE,          SPELL_SPIRIT_REMOVE_CURSE},
    {ITEM_SPELLBOOK_PRESERVATION,          SPELL_SPIRIT_PRESERVATION},
    {ITEM_SPELLBOOK_HEROISM,               SPELL_SPIRIT_HEROISM},
    {ITEM_SPELLBOOK_SPIRIT_LASH,           SPELL_SPIRIT_SPIRIT_LASH},
    {ITEM_SPELLBOOK_RAISE_DEAD,            SPELL_SPIRIT_RAISE_DEAD},
    {ITEM_SPELLBOOK_SHARED_LIFE,           SPELL_SPIRIT_SHARED_LIFE},
    {ITEM_SPELLBOOK_RESURRECTION,          SPELL_SPIRIT_RESSURECTION},

    {ITEM_SPELLBOOK_REMOVE_FEAR,           SPELL_MIND_REMOVE_FEAR},
    {ITEM_SPELLBOOK_MIND_BLAST,            SPELL_MIND_MIND_BLAST},
    {ITEM_SPELLBOOK_MIND_RESISTANCE,       SPELL_MIND_PROTECTION_FROM_MIND},
    {ITEM_SPELLBOOK_TELEPATHY,             SPELL_MIND_TELEPATHY},
    {ITEM_SPELLBOOK_CHARM,                 SPELL_MIND_CHARM},
    {ITEM_SPELLBOOK_CURE_PARALYSIS,        SPELL_MIND_CURE_PARALYSIS},
    {ITEM_SPELLBOOK_BERSERK,               SPELL_MIND_BERSERK},
    {ITEM_SPELLBOOK_MASS_FEAR,             SPELL_MIND_MASS_FEAR},
    {ITEM_SPELLBOOK_CURE_INSANITY,         SPELL_MIND_CURE_INSANITY},
    {ITEM_SPELLBOOK_PSYCHIC_SHOCK,         SPELL_MIND_PSYCHIC_SHOCK},
    {ITEM_SPELLBOOK_ENSLAVE,               SPELL_MIND_ENSLAVE},

    {ITEM_SPELLBOOK_CURE_WEAKNESS,         SPELL_BODY_CURE_WEAKNESS},
    {ITEM_SPELLBOOK_HEAL,                  SPELL_BODY_FIRST_AID},
    {ITEM_SPELLBOOK_BODY_RESISTANCE,       SPELL_BODY_PROTECTION_FROM_BODY},
    {ITEM_SPELLBOOK_HARM,                  SPELL_BODY_HARM},
    {ITEM_SPELLBOOK_REGENERATION,          SPELL_BODY_REGENERATION},
    {ITEM_SPELLBOOK_CURE_POISON,           SPELL_BODY_CURE_POISON},
    {ITEM_SPELLBOOK_HAMMERHANDS,           SPELL_BODY_HAMMERHANDS},
    {ITEM_SPELLBOOK_CURE_DISEASE,          SPELL_BODY_CURE_DISEASE},
    {ITEM_SPELLBOOK_PROTECTION_FROM_MAGIC, SPELL_BODY_PROTECTION_FROM_MAGIC},
    {ITEM_SPELLBOOK_FLYING_FIST,           SPELL_BODY_FLYING_FIST},
    {ITEM_SPELLBOOK_POWER_CURE,            SPELL_BODY_POWER_CURE},

    {ITEM_SPELLBOOK_LIGHT_BOLT,            SPELL_LIGHT_LIGHT_BOLT},
    {ITEM_SPELLBOOK_DESTROY_UNDEAD,        SPELL_LIGHT_DESTROY_UNDEAD},
    {ITEM_SPELLBOOK_DISPEL_MAGIC,          SPELL_LIGHT_DISPEL_MAGIC},
    {ITEM_SPELLBOOK_PARALYZE,              SPELL_LIGHT_PARALYZE},
    {ITEM_SPELLBOOK_SUMMON_ELEMENTAL,      SPELL_LIGHT_SUMMON_ELEMENTAL},
    {ITEM_SPELLBOOK_DAY_OF_THE_GODS,       SPELL_LIGHT_DAY_OF_THE_GODS},
    {ITEM_SPELLBOOK_PRISMATIC_LIGHT,       SPELL_LIGHT_PRISMATIC_LIGHT},
    {ITEM_SPELLBOOK_DAY_OF_PROTECTION,     SPELL_LIGHT_DAY_OF_PROTECTION},
    {ITEM_SPELLBOOK_HOUR_OF_POWER,         SPELL_LIGHT_HOUR_OF_POWER},
    {ITEM_SPELLBOOK_SUNRAY,                SPELL_LIGHT_SUNRAY},
    {ITEM_SPELLBOOK_DIVINE_INTERVENTION,   SPELL_LIGHT_DIVINE_INTERVENTION},

    {ITEM_SPELLBOOK_REANIMATE,             SPELL_DARK_REANIMATE},
    {ITEM_SPELLBOOK_TOXIC_CLOUD,           SPELL_DARK_TOXIC_CLOUD},
    {ITEM_SPELLBOOK_VAMPIRIC_WEAPON,       SPELL_DARK_VAMPIRIC_WEAPON},
    {ITEM_SPELLBOOK_SHRINKING_RAY,         SPELL_DARK_SHRINKING_RAY},
    {ITEM_SPELLBOOK_SHRAPMETAL,            SPELL_DARK_SHARPMETAL},
    {ITEM_SPELLBOOK_CONTROL_UNDEAD,        SPELL_DARK_CONTROL_UNDEAD},
    {ITEM_SPELLBOOK_PAIN_REFLECTION,       SPELL_DARK_PAIN_REFLECTION},
    {ITEM_SPELLBOOK_SACRIFICE,             SPELL_DARK_SACRIFICE},
    {ITEM_SPELLBOOK_DRAGON_BREATH,         SPELL_DARK_DRAGON_BREATH},
    {ITEM_SPELLBOOK_ARMAGEDDON,            SPELL_DARK_ARMAGEDDON},
    {ITEM_SPELLBOOK_SOULDRINKER,           SPELL_DARK_SOULDRINKER}
};

std::array<std::array<struct SpellBookIconPos, 12>, 9> pIconPos = {{
    {{{0,   0},   {17,  13},  {115, 2},   {217, 15},  {299, 6},   {28,  125},
      {130, 133}, {294, 114}, {11,  232}, {134, 233}, {237, 171}, {296, 231}}},

    {{{0,   0},   {19,  9},   {117, 3},   {206, 13},  {285, 7},   {16,  123},
      {113, 101}, {201, 118}, {317, 110}, {11,  230}, {149, 236}, {296, 234}}},

    {{{0,  0},   {17,  9},   {140, 0},   {210, 34},  {293, 5},   {15,  98},
      {78, 121}, {175, 136}, {301, 115}, {15,  226}, {154, 225}, {272, 220}}},

    {{{0,   0},   {7,   9},   {156, 2},   {277, 9},   {11,  117}, {111, 82},
      {180, 102}, {303, 108}, {10,  229}, {120, 221}, {201, 217}, {296, 225}}},

    {{{0,   0},   {18,  8},   {89,  15},  {192, 14},  {292, 7},   {22,  129},
      {125, 146}, {217, 136}, {305, 115}, {22,  226}, {174, 237}, {290, 231}}},

    {{{0,   0},  {18,  12},  {148, 9},   {292, 7},   {17,  122}, {121, 99},
      {220, 87}, {293, 112}, {13,  236}, {128, 213}, {220, 223}, {315, 223}}},

    {{{0,   0},   {23,  14},  {127, 8},   {204, 0},   {306, 8},   {14,  115},
      {122, 132}, {200, 116}, {293, 122}, {20,  228}, {154, 228}, {294, 239}}},

    {{{0,   0},  {19,  14},  {124, 10},  {283, 12},  {8,   105}, {113, 89},
      {190, 82}, {298, 108}, {18,  181}, {101, 204}, {204, 203}, {285, 218}}},

    {{{0,   0},   {18,  17},  {110, 16},  {201, 15},  {307, 15},  {18,  148},
      {125, 166}, {201, 123}, {275, 120}, {28,  235}, {217, 222}, {324, 216}}}
}};

// TODO: use SoundID not uint16_t
// TODO(captainurist): Originally the array was two elements shorter, last two zeros are my addition. Can we drop elements for non-regular spells?
const IndexedArray<uint16_t, SPELL_FIRST_WITH_SPRITE, SPELL_LAST_WITH_SPRITE> SpellSoundIds = {{
    {SPELL_FIRE_TORCH_LIGHT, 10000},
    {SPELL_FIRE_FIRE_BOLT, 10010},
    {SPELL_FIRE_PROTECTION_FROM_FIRE, 10020},
    {SPELL_FIRE_FIRE_AURA, 10030},
    {SPELL_FIRE_HASTE, 10040},
    {SPELL_FIRE_FIREBALL, 10050},
    {SPELL_FIRE_FIRE_SPIKE, 10060},
    {SPELL_FIRE_IMMOLATION, 10070},
    {SPELL_FIRE_METEOR_SHOWER, 10080},
    {SPELL_FIRE_INFERNO, 10090},
    {SPELL_FIRE_INCINERATE, 10100},
    {SPELL_AIR_WIZARD_EYE, 11000},
    {SPELL_AIR_FEATHER_FALL, 11010},
    {SPELL_AIR_PROTECTION_FROM_AIR, 11020},
    {SPELL_AIR_SPARKS, 11030},
    {SPELL_AIR_JUMP, 11040},
    {SPELL_AIR_SHIELD, 11050},
    {SPELL_AIR_LIGHTNING_BOLT, 11060},
    {SPELL_AIR_INVISIBILITY, 11070},
    {SPELL_AIR_IMPLOSION, 11080},
    {SPELL_AIR_FLY, 11090},
    {SPELL_AIR_STARBURST, 11100},
    {SPELL_WATER_AWAKEN, 12000},
    {SPELL_WATER_POISON_SPRAY, 12010},
    {SPELL_WATER_PROTECTION_FROM_WATER, 12020},
    {SPELL_WATER_ICE_BOLT, 12030},
    {SPELL_WATER_WATER_WALK, 12040},
    {SPELL_WATER_RECHARGE_ITEM, 12050},
    {SPELL_WATER_ACID_BURST, 12060},
    {SPELL_WATER_ENCHANT_ITEM, 12070},
    {SPELL_WATER_TOWN_PORTAL, 12080},
    {SPELL_WATER_ICE_BLAST, 12090},
    {SPELL_WATER_LLOYDS_BEACON, 12100},
    {SPELL_EARTH_STUN, 13000},
    {SPELL_EARTH_SLOW, 13010},
    {SPELL_EARTH_PROTECTION_FROM_EARTH, 13020},
    {SPELL_EARTH_DEADLY_SWARM, 13030},
    {SPELL_EARTH_STONESKIN, 13040},
    {SPELL_EARTH_BLADES, 13050},
    {SPELL_EARTH_STONE_TO_FLESH, 13060},
    {SPELL_EARTH_ROCK_BLAST, 13070},
    {SPELL_EARTH_TELEKINESIS, 13080},
    {SPELL_EARTH_DEATH_BLOSSOM, 13090},
    {SPELL_EARTH_MASS_DISTORTION, 13100},
    {SPELL_SPIRIT_DETECT_LIFE, 14000},
    {SPELL_SPIRIT_BLESS, 14010},
    {SPELL_SPIRIT_FATE, 14020},
    {SPELL_SPIRIT_TURN_UNDEAD, 14030},
    {SPELL_SPIRIT_REMOVE_CURSE, 14040},
    {SPELL_SPIRIT_PRESERVATION, 14050},
    {SPELL_SPIRIT_HEROISM, 14060},
    {SPELL_SPIRIT_SPIRIT_LASH, 14070},
    {SPELL_SPIRIT_RAISE_DEAD, 14080},
    {SPELL_SPIRIT_SHARED_LIFE, 14090},
    {SPELL_SPIRIT_RESSURECTION, 14100},
    {SPELL_MIND_REMOVE_FEAR, 15000},
    {SPELL_MIND_MIND_BLAST, 15010},
    {SPELL_MIND_PROTECTION_FROM_MIND, 15020},
    {SPELL_MIND_TELEPATHY, 15030},
    {SPELL_MIND_CHARM, 15040},
    {SPELL_MIND_CURE_PARALYSIS, 15050},
    {SPELL_MIND_BERSERK, 15060},
    {SPELL_MIND_MASS_FEAR, 15070},
    {SPELL_MIND_CURE_INSANITY, 15080},
    {SPELL_MIND_PSYCHIC_SHOCK, 15090},
    {SPELL_MIND_ENSLAVE, 15100},
    {SPELL_BODY_CURE_WEAKNESS, 16000},
    {SPELL_BODY_FIRST_AID, 16010},
    {SPELL_BODY_PROTECTION_FROM_BODY, 16020},
    {SPELL_BODY_HARM, 16030},
    {SPELL_BODY_REGENERATION, 16040},
    {SPELL_BODY_CURE_POISON, 16050},
    {SPELL_BODY_HAMMERHANDS, 16060},
    {SPELL_BODY_CURE_DISEASE, 16070},
    {SPELL_BODY_PROTECTION_FROM_MAGIC, 16080},
    {SPELL_BODY_FLYING_FIST, 16090},
    {SPELL_BODY_POWER_CURE, 16100},
    {SPELL_LIGHT_LIGHT_BOLT, 17000},
    {SPELL_LIGHT_DESTROY_UNDEAD, 17010},
    {SPELL_LIGHT_DISPEL_MAGIC, 17020},
    {SPELL_LIGHT_PARALYZE, 17030},
    {SPELL_LIGHT_SUMMON_ELEMENTAL, 17040},
    {SPELL_LIGHT_DAY_OF_THE_GODS, 17050},
    {SPELL_LIGHT_PRISMATIC_LIGHT, 17060},
    {SPELL_LIGHT_DAY_OF_PROTECTION, 17070},
    {SPELL_LIGHT_HOUR_OF_POWER, 17080},
    {SPELL_LIGHT_SUNRAY, 17090},
    {SPELL_LIGHT_DIVINE_INTERVENTION, 17100},
    {SPELL_DARK_REANIMATE, 18000},
    {SPELL_DARK_TOXIC_CLOUD, 18010},
    {SPELL_DARK_VAMPIRIC_WEAPON, 18020},
    {SPELL_DARK_SHRINKING_RAY, 18030},
    {SPELL_DARK_SHARPMETAL, 18040},
    {SPELL_DARK_CONTROL_UNDEAD, 18050},
    {SPELL_DARK_PAIN_REFLECTION, 18060},
    {SPELL_DARK_SACRIFICE, 18070},
    {SPELL_DARK_DRAGON_BREATH, 18080},
    {SPELL_DARK_ARMAGEDDON, 18090},
    {SPELL_DARK_SOULDRINKER, 18100},
    {SPELL_BOW_ARROW, 00001},
    {SPELL_101, 00000},
    {SPELL_LASER_PROJECTILE, 00000}
}};

void SpellBuff::Reset() {
    skillMastery = CHARACTER_SKILL_MASTERY_NONE;
    power = 0;
    expireTime.Reset();
    caster = 0;
    isGMBuff = false;
    if (overlayID) {
        pActiveOverlayList->pOverlays[overlayID - 1].Reset();
        overlayID = 0;
    }
}

bool SpellBuff::IsBuffExpiredToTime(GameTime time) {
    if (this->expireTime && (this->expireTime < time)) {
        expireTime.SetExpired();
        power = 0;
        skillMastery = CHARACTER_SKILL_MASTERY_NONE;
        overlayID = 0;
        return true;
    }
    return false;
}

bool SpellBuff::Apply(GameTime expire_time, CharacterSkillMastery uSkillMastery,
                      int uPower, int uOverlayID,
                      uint8_t caster) {
    // For bug catching
    Assert(uSkillMastery >= CHARACTER_SKILL_MASTERY_NOVICE && uSkillMastery <= CHARACTER_SKILL_MASTERY_GRANDMASTER
        && "SpellBuff::Apply");

    if (this->expireTime && (expire_time < this->expireTime)) {
        return false;
    }

    this->skillMastery = uSkillMastery;
    this->power = uPower;
    this->expireTime = expire_time;
    if (this->overlayID && this->overlayID != uOverlayID) {
        pActiveOverlayList->pOverlays[this->overlayID - 1].Reset();
        this->overlayID = 0;
    }
    this->overlayID = uOverlayID;
    this->caster = caster;

    return true;
}

void SpellStats::Initialize(const Blob &spells) {
    std::map<std::string, SPELL_SCHOOL, ILess> spellSchoolMaps;
    spellSchoolMaps["fire"] = SPELL_SCHOOL_FIRE;
    spellSchoolMaps["air"] = SPELL_SCHOOL_AIR;
    spellSchoolMaps["water"] = SPELL_SCHOOL_WATER;
    spellSchoolMaps["earth"] = SPELL_SCHOOL_EARTH;
    spellSchoolMaps["spirit"] = SPELL_SCHOOL_SPIRIT;
    spellSchoolMaps["mind"] = SPELL_SCHOOL_MIND;
    spellSchoolMaps["body"] = SPELL_SCHOOL_BODY;
    spellSchoolMaps["light"] = SPELL_SCHOOL_LIGHT;
    spellSchoolMaps["dark"] = SPELL_SCHOOL_DARK;
    spellSchoolMaps["magic"] = SPELL_SCHOOL_MAGIC;

    char *test_string;

    std::string txtRaw(spells.string_view());

    strtok(txtRaw.data(), "\r");
    for (SPELL_TYPE uSpellID : allRegularSpells()) {
        if (((std::to_underlying(uSpellID) % 11) - 1) == 0) {
            strtok(NULL, "\r");
        }
        test_string = strtok(NULL, "\r") + 1;

        auto tokens = tokenize(test_string, '\t');

        pInfos[uSpellID].name = removeQuotes(tokens[2]);
        auto findResult = spellSchoolMaps.find(tokens[3]);
        pInfos[uSpellID].uSchool = findResult == spellSchoolMaps.end()
                                ? SPELL_SCHOOL_NONE
                                : findResult->second;
        pInfos[uSpellID].pShortName = removeQuotes(tokens[4]);
        pInfos[uSpellID].pDescription = removeQuotes(tokens[5]);
        pInfos[uSpellID].pBasicSkillDesc = removeQuotes(tokens[6]);
        pInfos[uSpellID].pExpertSkillDesc = removeQuotes(tokens[7]);
        pInfos[uSpellID].pMasterSkillDesc = removeQuotes(tokens[8]);
        pInfos[uSpellID].pGrandmasterSkillDesc = removeQuotes(tokens[9]);
        pSpellDatas[uSpellID].stats |= strchr(tokens[10], 'm') || strchr(tokens[10], 'M') ? 1 : 0;
        pSpellDatas[uSpellID].stats |= strchr(tokens[10], 'e') || strchr(tokens[10], 'E') ? 2 : 0;
        pSpellDatas[uSpellID].stats |= strchr(tokens[10], 'c') || strchr(tokens[10], 'C') ? 4 : 0;
        pSpellDatas[uSpellID].stats |= strchr(tokens[10], 'x') || strchr(tokens[10], 'X') ? 8 : 0;
    }
}

void eventCastSpell(SPELL_TYPE uSpellID, CharacterSkillMastery skillMastery, int skillLevel, int fromx,
                    int fromy, int fromz, int tox, int toy, int toz) {
    // For bug catching
    Assert(skillMastery >= CHARACTER_SKILL_MASTERY_NOVICE && skillMastery <= CHARACTER_SKILL_MASTERY_GRANDMASTER,
          "eventCastSpell - Invalid mastery level");

    Vec3i from(fromx, fromy, fromz);
    Vec3i to(tox, toy, toz);
    Vec3i coord_delta;
    if (tox || toy || toz) {
        coord_delta = to - from;
    } else {
        coord_delta = pParty->pos - from + Vec3i(0, 0, pParty->eyeLevel);
    }

    int yaw = 0;
    int pitch = 0;
    float distance_to_target = coord_delta.toFloat().length();
    if (distance_to_target <= 1.0) {
        distance_to_target = 1;
    } else {
        int64_t ySquared = coord_delta.y * coord_delta.y;
        int64_t xSquared = coord_delta.x * coord_delta.x;
        int xy_distance = (int)std::sqrt((double)(xSquared + ySquared));
        yaw = TrigLUT.atan2(coord_delta.x, coord_delta.y);
        pitch = TrigLUT.atan2(xy_distance, coord_delta.z);
    }

    SpriteObject spell_sprites;

    switch (uSpellID) {
        case SPELL_FIRE_FIRE_BOLT:
        case SPELL_FIRE_FIREBALL:
        case SPELL_AIR_LIGHTNING_BOLT:
        case SPELL_WATER_ICE_BOLT:
        case SPELL_WATER_ACID_BURST:
        case SPELL_WATER_ICE_BLAST:
        case SPELL_EARTH_BLADES:
        case SPELL_EARTH_ROCK_BLAST:
        case SPELL_WATER_POISON_SPRAY:
        case SPELL_AIR_SPARKS:
        case SPELL_EARTH_DEATH_BLOSSOM:
            spell_sprites.uType = SpellSpriteMapping[uSpellID];
            spell_sprites.containing_item.Reset();
            spell_sprites.uSpellID = uSpellID;
            spell_sprites.spell_level = skillLevel;
            spell_sprites.spell_skill = skillMastery;
            spell_sprites.uObjectDescID = pObjectList->ObjectIDByItemID(spell_sprites.uType);
            spell_sprites.vPosition = from;
            spell_sprites.uAttributes = SPRITE_IGNORE_RANGE;
            spell_sprites.uSectorID = pIndoor->GetSector(from);
            spell_sprites.field_60_distance_related_prolly_lod = distance_to_target;
            spell_sprites.uSpriteFrameID = 0;
            spell_sprites.spell_caster_pid = PID(OBJECT_Item, 1000); // 8000 | OBJECT_Item;
            spell_sprites.uSoundID = 0;
            break;
        default:
            break;
    }

    GameTime spell_length;
    int spell_power = 0;
    int launch_angle;
    int launch_speed;
    int spell_num_objects;
    int spell_spray_arc;
    int spell_spray_angles;
    int spriteid;
    PARTY_BUFF_INDEX buff_id;

    switch (uSpellID) {
        case SPELL_FIRE_FIRE_BOLT:
        case SPELL_FIRE_FIREBALL:
        case SPELL_AIR_LIGHTNING_BOLT:
        case SPELL_WATER_ICE_BOLT:
        case SPELL_WATER_ACID_BURST:
        case SPELL_WATER_ICE_BLAST:
        case SPELL_EARTH_BLADES:
        case SPELL_EARTH_ROCK_BLAST:
            // v20 = yaw;
            spell_sprites.spell_target_pid = 0;
            spell_sprites.uFacing = yaw;
            spell_sprites.uSoundID = 0;
            launch_speed = pObjectList->pObjects[(int16_t)spell_sprites.uObjectDescID].uSpeed;
            spriteid = spell_sprites.Create(yaw, pitch, launch_speed, 0);
            //    pAudioPlayer->PlaySound((SoundID)word_4EE088_sound_ids[uSpellID],
            //    0, 0, fromx, fromy, 0, 0, 0);
            pAudioPlayer->playSpellSound(uSpellID, false, SOUND_MODE_PID, PID(OBJECT_Item, spriteid));
            break;
        case SPELL_WATER_POISON_SPRAY:
            spell_num_objects = (std::to_underlying(skillMastery) * 2) - 1;
            spell_sprites.spell_target_pid = 0;
            spell_sprites.uFacing = yaw;
            if (spell_num_objects == 1) {
                launch_speed = pObjectList->pObjects[(int16_t)spell_sprites.uObjectDescID].uSpeed;
                spriteid = spell_sprites.Create(yaw, pitch, launch_speed, 0);
            } else {
                spell_spray_arc = (signed int)(60 * TrigLUT.uIntegerDoublePi) / 360;
                spell_spray_angles = spell_spray_arc / (spell_num_objects - 1);
                for (int i = spell_spray_arc / -2; i <= spell_spray_arc / 2; i += spell_spray_angles) {
                    spell_sprites.uFacing = i + yaw;
                    spriteid = spell_sprites.Create(i + yaw, pitch, pObjectList->pObjects[spell_sprites.uObjectDescID].uSpeed, 0);
                }
            }
            //    pAudioPlayer->PlaySound((SoundID)word_4EE088_sound_ids[uSpellID],
            //    0, 0, fromx, fromy, 0, 0, 0);
            pAudioPlayer->playSpellSound(uSpellID, false, SOUND_MODE_PID, PID(OBJECT_Item, spriteid));
            break;
        case SPELL_AIR_SPARKS:
            spell_num_objects = (std::to_underlying(skillMastery) * 2) + 1;
            spell_spray_arc = (signed int)(60 * TrigLUT.uIntegerDoublePi) / 360;
            spell_spray_angles = spell_spray_arc / (spell_num_objects - 1);
            spell_sprites.spell_target_pid = 4;
            for (int i = spell_spray_arc / -2; i <= spell_spray_arc / 2; i += spell_spray_angles) {
                spell_sprites.uFacing = i + yaw;
                spriteid = spell_sprites.Create(i + yaw, pitch, pObjectList->pObjects[spell_sprites.uObjectDescID].uSpeed, 0);
            }
            //    pAudioPlayer->PlaySound((SoundID)word_4EE088_sound_ids[uSpellID],
            //    0, 0, fromx, fromy, 0, 0, 0);
            pAudioPlayer->playSpellSound(uSpellID, false, SOUND_MODE_PID, PID(OBJECT_Item, spriteid));
            break;
        case SPELL_EARTH_DEATH_BLOSSOM:
            if (uCurrentlyLoadedLevelType == LEVEL_INDOOR) {
                return;
            }
            spell_sprites.spell_target_pid = 4;
            launch_speed = pObjectList->pObjects[spell_sprites.uObjectDescID].uSpeed;
            launch_angle = TrigLUT.uIntegerHalfPi / 2;
            spriteid = spell_sprites.Create(yaw, launch_angle, launch_speed, 0);
            //    pAudioPlayer->PlaySound((SoundID)word_4EE088_sound_ids[uSpellID],
            //    0, 0, fromx, fromy, 0, 0, 0);
            pAudioPlayer->playSpellSound(uSpellID, false, SOUND_MODE_PID, PID(OBJECT_Item, spriteid));
            break;

        case SPELL_FIRE_HASTE:
            if (skillMastery >= CHARACTER_SKILL_MASTERY_NOVICE) {
                if (skillMastery <= CHARACTER_SKILL_MASTERY_EXPERT) {
                    spell_length = GameTime::FromHours(1).AddMinutes(skillLevel);
                } else if (skillMastery == CHARACTER_SKILL_MASTERY_MASTER) {
                    spell_length = GameTime::FromHours(1).AddMinutes(3 * skillLevel);
                } else if (skillMastery == CHARACTER_SKILL_MASTERY_GRANDMASTER) {
                    spell_length = GameTime::FromHours(1).AddMinutes(4 * skillLevel);
                }
            }
            for (Character &player : pParty->pCharacters) {
                if (player.IsWeak()) {
                    return;
                }
            }
            pParty->pPartyBuffs[PARTY_BUFF_HASTE].Apply(pParty->GetPlayingTime() + spell_length, skillMastery, 0, 0, 0);
            spell_fx_renderer->SetPartyBuffAnim(uSpellID);
            //    pAudioPlayer->PlaySound((SoundID)word_4EE088_sound_ids[uSpellID],
            //    0, 0, fromx, fromy, 0, 0, 0);  // звук алтаря
            //    PID was 0
            pAudioPlayer->playSpellSound(uSpellID, false, SOUND_MODE_EXCLUSIVE);
            break;
        case SPELL_AIR_SHIELD:
        case SPELL_EARTH_STONESKIN:
        case SPELL_SPIRIT_HEROISM:
            switch (skillMastery) {
                case CHARACTER_SKILL_MASTERY_NOVICE:
                case CHARACTER_SKILL_MASTERY_EXPERT:
                    spell_length = GameTime::FromHours(1).AddMinutes(5 * skillLevel);
                    break;
                case CHARACTER_SKILL_MASTERY_MASTER:
                    spell_length = GameTime::FromHours(1).AddMinutes(15 * skillLevel);
                    break;
                case CHARACTER_SKILL_MASTERY_GRANDMASTER:
                    spell_length = GameTime::FromHours(skillLevel + 1);
                    break;
                default:
                    assert(false);
                    break;
            }
            if (uSpellID == SPELL_AIR_SHIELD) {
                spell_power = 0;
                buff_id = PARTY_BUFF_SHIELD;
            } else if (uSpellID == SPELL_EARTH_STONESKIN) {
                spell_power = skillLevel + 5;
                buff_id = PARTY_BUFF_STONE_SKIN;
            } else {
                assert(uSpellID == SPELL_SPIRIT_HEROISM);
                spell_power = skillLevel + 5;
                buff_id = PARTY_BUFF_HEROISM;
            }
            spell_fx_renderer->SetPartyBuffAnim(uSpellID);
            pParty->pPartyBuffs[buff_id].Apply(pParty->GetPlayingTime() + spell_length, skillMastery, spell_power, 0, 0);
            //    pAudioPlayer->PlaySound((SoundID)word_4EE088_sound_ids[uSpellID],
            //    0, 0, fromx, fromy, 0, 0, 0);
            //    PID was 0
            pAudioPlayer->playSpellSound(uSpellID, false, SOUND_MODE_EXCLUSIVE);
            break;
        case SPELL_FIRE_IMMOLATION:
            if (skillMastery == CHARACTER_SKILL_MASTERY_GRANDMASTER) {
                spell_length = GameTime::FromMinutes(10 * skillLevel);
            } else {
                spell_length = GameTime::FromMinutes(skillLevel);
            }
            spell_fx_renderer->SetPartyBuffAnim(uSpellID);
            pParty->pPartyBuffs[PARTY_BUFF_IMMOLATION].Apply(pParty->GetPlayingTime() + spell_length, skillMastery, skillLevel, 0, 0);
            //    pAudioPlayer->PlaySound((SoundID)word_4EE088_sound_ids[uSpellID],
            //    0, 0, fromx, fromy, 0, 0, 0);
            //    PID was 0
            pAudioPlayer->playSpellSound(uSpellID, false, SOUND_MODE_EXCLUSIVE);
            break;
        case SPELL_FIRE_PROTECTION_FROM_FIRE:
        case SPELL_AIR_PROTECTION_FROM_AIR:
        case SPELL_WATER_PROTECTION_FROM_WATER:
        case SPELL_EARTH_PROTECTION_FROM_EARTH:
        case SPELL_MIND_PROTECTION_FROM_MIND:
        case SPELL_BODY_PROTECTION_FROM_BODY:
            spell_length = GameTime::FromHours(skillLevel);
            spell_power = skillLevel * std::to_underlying(skillMastery);

            if (uSpellID == SPELL_FIRE_PROTECTION_FROM_FIRE) {
                buff_id = PARTY_BUFF_RESIST_FIRE;
            } else if (uSpellID == SPELL_AIR_PROTECTION_FROM_AIR) {
                buff_id = PARTY_BUFF_RESIST_AIR;
            } else if (uSpellID == SPELL_WATER_PROTECTION_FROM_WATER) {
                buff_id = PARTY_BUFF_RESIST_WATER;
            } else if (uSpellID == SPELL_EARTH_PROTECTION_FROM_EARTH) {
                buff_id = PARTY_BUFF_RESIST_EARTH;
            } else if (uSpellID == SPELL_MIND_PROTECTION_FROM_MIND) {
                buff_id = PARTY_BUFF_RESIST_MIND;
            } else {
                assert(uSpellID == SPELL_BODY_PROTECTION_FROM_BODY);
                buff_id = PARTY_BUFF_RESIST_BODY;
            }

            spell_fx_renderer->SetPartyBuffAnim(uSpellID);
            pParty->pPartyBuffs[buff_id].Apply(pParty->GetPlayingTime() + spell_length, skillMastery, spell_power, 0, 0);
            //    pAudioPlayer->PlaySound((SoundID)word_4EE088_sound_ids[uSpellID],
            //    0, 0, fromx, fromy, 0, 0, 0);
            //    PID was 0
            pAudioPlayer->playSpellSound(uSpellID, false, SOUND_MODE_EXCLUSIVE);
            break;
        case SPELL_LIGHT_DAY_OF_THE_GODS:
            // Spell lengths for master and grandmaster were mixed up
            switch (skillMastery) {
                case CHARACTER_SKILL_MASTERY_EXPERT:
                    spell_length = GameTime::FromHours(3 * skillLevel);
                    spell_power = 3 * skillLevel + 10;
                    break;
                case CHARACTER_SKILL_MASTERY_MASTER:
                    spell_length = GameTime::FromHours(4 * skillLevel);
                    spell_power = 5 * skillLevel + 10;
                    break;
                case CHARACTER_SKILL_MASTERY_GRANDMASTER:
                    spell_length = GameTime::FromHours(5 * skillLevel);
                    spell_power = 4 * skillLevel + 10;
                    break;
                default:
                    break;
            }
            spell_fx_renderer->SetPartyBuffAnim(uSpellID);

            pParty->pPartyBuffs[PARTY_BUFF_DAY_OF_GODS].Apply(pParty->GetPlayingTime() + spell_length, skillMastery, spell_power, 0, 0);
            //    pAudioPlayer->PlaySound((SoundID)word_4EE088_sound_ids[uSpellID],
            //    0, 0, fromx, fromy, 0, 0, 0);
            //    PID was 0
            pAudioPlayer->playSpellSound(uSpellID, false, SOUND_MODE_EXCLUSIVE);
            break;
        default:
            break;
    }
}

bool IsSpellQuickCastableOnShiftClick(SPELL_TYPE uSpellID) {
    return (pSpellDatas[uSpellID].stats & 0xC) != 0;
}

int CalcSpellDamage(SPELL_TYPE uSpellID, int spellLevel, CharacterSkillMastery skillMastery, int currentHp) {
    int result;       // eax@1
    unsigned int diceSides;  // [sp-4h] [bp-8h]@9

    result = 0;
    if (uSpellID == SPELL_FIRE_FIRE_SPIKE) {
        switch (skillMastery) {
            case CHARACTER_SKILL_MASTERY_NOVICE:
            case CHARACTER_SKILL_MASTERY_EXPERT:
                diceSides = 6;
                break;
            case CHARACTER_SKILL_MASTERY_MASTER:
                diceSides = 8;
                break;
            case CHARACTER_SKILL_MASTERY_GRANDMASTER:
                diceSides = 10;
                break;
            default:
                return 0;
        }
        result = grng->randomDice(spellLevel, diceSides);
    } else if (uSpellID == SPELL_EARTH_MASS_DISTORTION) {
        result = currentHp * (pSpellDatas[SPELL_EARTH_MASS_DISTORTION].baseDamage + 2 * spellLevel) / 100;
    } else {
        result = pSpellDatas[uSpellID].baseDamage + grng->randomDice(spellLevel, pSpellDatas[uSpellID].bonusSkillDamage);
    }

    return result;
}

void armageddonProgress() {
    assert(uCurrentlyLoadedLevelType == LEVEL_OUTDOOR && pParty->armageddon_timer > 0);

    if (pParty->armageddon_timer > 417) {
        pParty->armageddon_timer = 0;
        return; // TODO(captainurist): wtf? Looks like a quick hack for some bug.
    }

    if (pTurnEngine->pending_actions) {
        --pTurnEngine->pending_actions;
    }

    pParty->_viewYaw = TrigLUT.uDoublePiMask & (pParty->_viewYaw + grng->randomInSegment(-8, 8)); // Was RandomInSegment(-8, 7)
    pParty->_viewPitch = std::clamp(pParty->_viewPitch + grng->randomInSegment(-8, 8), -128, 128); // Was RandomInSegment(-8, 7)
    pParty->uFlags |= PARTY_FLAGS_1_ForceRedraw;
    pParty->armageddon_timer -= pEventTimer->uTimeElapsed; // Was pMiscTimer

    // TODO(pskelton): ignore if pEventTimer->uTimeElapsed is zero?
    // TODO(captainurist): See the logic in Outdoor.cpp, right now the force is applied in fixed amounts per frame,
    // while it should be applied in amounts relative to frame time --- basically, armageddon should provide some
    // acceleration, and then this acceleration should be applied to actors over a brief period of time.
    --pParty->armageddonForceCount;
    if (pParty->armageddon_timer > 0) {
        return; // Deal damage only when timer gets to 0.
    }
    pParty->armageddon_timer = 0;

    int outgoingDamage = pParty->armageddonDamage + 50;

    for (Actor &actor : pActors) {
        if (!actor.CanAct()) {
            continue; // TODO(captainurist): paralyzed & summoned actors should receive damage too!
        }

        int incomingDamage = actor.CalcMagicalDamageToActor(DMGT_MAGICAL, outgoingDamage);
        if (incomingDamage > 0) {
            actor.currentHP -= incomingDamage;

            if (actor.currentHP >= 0) {
                Actor::AI_Stun(actor.id, Pid::character(0), 0);
            } else {
                Actor::Die(actor.id);
                if (actor.monsterInfo.uExp) {
                    pParty->GivePartyExp(pMonsterStats->pInfos[actor.monsterInfo.uID].uExp);
                }
            }
        }
    }

    for (Character &player : pParty->pCharacters) {
        if (!player.conditions.HasAny({CONDITION_DEAD, CONDITION_PETRIFIED, CONDITION_ERADICATED})) {
            player.receiveDamage(outgoingDamage, DMGT_MAGICAL);
        }
    }
}
